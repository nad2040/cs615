# OSI Layers

Political - someone controls what you do
Financial - someone's gotta pay

Application - it's the application
Presentation - confusion
Session - confusion
Transport - most of TCP
Network - packet transfer between networks
Link - node to node transfer (PPP, MAC, ...)
Physical - medium and bit rate, full duplex, half duplex, etc

tcpdump - capturing network packets
`sudo tcpdump -w /tmp/out port 80 2>/dev/null &`

# TCP/IP

Frame Header | IP Header | TCP Header | TCP Data | Frame Footer

12 bytes - link layer
- 6 for link layer destination
- 6 for link layer source - basically just MAC address

2 bytes - protocol
24 bytes - IP header
remainder - TCP payload

check arp cache with `arp -n -a` shows link layer dest as default gateway

`netstat -nr | grep <ip>`

RFC791 defines IPv4 packet header
4 bits for version 4
4 bits for header len in multiples of 4 bytes / 32 bits
1 byte for type of service - differentiated services code point (DSCP) and Explicit Congestion Notification (ECN)
2 bytes total length of packet in bytes
2 bytes for identification
3 bits for flags
13 bits for fragment offset
1 byte for time to live (ttl) - default 64 = 0x40
1 byte protocol - TCP = 0x06
2 byte header checksum
4 byte source address
4 byte destination address
options and padding

```bc
ibase=16 # for inserting hexadecimal
```
https://www.netmeister.org/ip.sh

# IPv4

32-bit

IPv4 addresses are divided into network and host component

Hosts on the same network (broadcast domain) can talk to each other without the help of a router.

In the early days, you looked at first 3 bits. Three types of classes: A B D

Well actually 5 classes from first 4 bits.

Class A - 0
- 8 bit network

Class B - 10
- 16 bit network

Class C - 110
- 24 bit network

Class D - 1110
- multicast

Class E - 1111
- reserved

Netmask allows you to divide network into smaller networks (subnets).

for example: 255.255.255.0 = /24

`ipcalc addr/n` gives information about mask and network.

Special addresses:
- First address = network address itself
- Last address = broadcast address

so we get 2 fewer hosts

`ipcalc -s n1 n2 n3 addr/n` helps you carve out the ip addr space.

^
CIDR = Classless Inter-Domain Routing

# IPv6

128-bit

IPv6 Header Layout

4 bits for version 6
8 bit traffic class - DSCP and ECN
20 bit flow label - flow = group of packets that belong together. generated randomly
2 byte payload length
1 byte next header - protocol = 0x06
1 byte hop limit - default 64 = 0x40
1 byte protocol - TCP = 0x06
128 bit source addr
128 bit dest addr

split by 8 16-bit fields separated by colons
leading 0's are optional
successive fields of 0's represented by :: but only once in an address.

special cases:
- loopback: ::1
- IPv4 mapped addresses: ::ffff:octet.octet.octet.octet (10 byte leading 0)

Port syntax:
- \[IPv6 addr\]:port

IPv6 Address Scope
- each interface always has a link-local address:
  - fe80::/10 - lower 64 bits generated by standard algorithm
  - used on single link
  - packets with link-local source or dest addrs are not forwarded to other links
- unique local address (fc00::/7, although practically fd00::/8):
  - private IPv6 networks (similar to IPv4 RFC1918 private IP space)
  - not globally routable
- global address
  - globally unique address
  - can be forwarded to any part of global internet

`sipcalc` is basically `ipcalc` for IPv6.

most common prefix is /64.

# IPv4 exhaustion

IPv5 - internet stream protocol
v1
v2
v3 - tcp and ip was split

Jon Postel - Internet Assigned Number Authority (IANA)
- coauthored RFCs including the DNS

Administration of IANA was transferred to ICANN

Postel's law - robustness principle
- be liberal in what you accept, and conservative in what you send.

IANA oversees global IP and AS number allocation, root zone management, etc.

IANA may assign large chunks of addresses to a Regional Internet Registry (RIR).
- AFRINIC - African Network Information Centre
- APNIC - Asia Pacific Network Information Centre
- ARIN - American Registry for Internet Numbers
- LACNIC - Latin America and Carribean NIC
- RIPE NCC - Réseaux IP Européens Network Coordination Centre

The RIRs are loosely organized as the Number Resource Organization

These RIRs assign their netblocks to Local Internet Registries (LIR)

Most LIRs are Internet Service Providers (ISPs) or academic institutions or large scale enterprises.

Vint Cerf chose 32 bits for IPv4 because he thought it would be enough to do an experiment.

Private IP space: 10./8 172.16./12 192.168./16
other reserved space...

Those make up 13% of the IPv4 space.

In the early days, class As were handed out liberally
Subnetting is often inefficient with fragmentation
IoT doesn't help at all...

IANA address pool exhaustion 2011-02-03
APNIC reached final /8 in 2011-04-19
RIPE NCC reached final /8 in 2012-09-14
LACNIC reached final /8 in 2014-06-10
ARIN reached final /8 in 2015-09-24
AFRINIC reached final /11 in 2020-01-13

IPv6 is _REALLY_ big

Single End User LANs get /64

# Physical internet

Submarine Internet Cables!
[https://www.submarinecablemap.com]

Shark bites!

Ship anchors may cut internet cables :( and lead to internet outages

The Net interpreted censorship as damage and routes around it. - John Gilmore 1993

India "leads" in internet shutdowns.

Room 641A - secret network closet in AT&T SBC in San Francisco
- was secret
- whistleblown by Mark Klein - wiretapping by government

# Network of Networks

## Autonomous Systems
Networks that are grouped together.

The Border Gateway Protocol (BGP) shares its routes via which AS number it can talk to.

`whois(1)`
- start at IANA -> RIRs

whois 155.246.0.0:
155/8 is assigned to ARIN
155.246/16 is assigned to Stevens

AS16889 is Stevens' AS number.

Actually, there are three network blocks:
2620:10f::/44
155.246/16
192.12.216/24

change the whois server:
```sh
whois -h whois.cymru.com 130.156.251.105

AS      | IP               | AS Name
21976   | 130.156.251.105  | NJEDGE-NET, US
```

`traceroute` - check the hops to networks

`traceroute -A` to show the AS numbers. `-a` on macOS

An organization can have multiple AS numbers.

## Peering DB

The process of connecting networks. Exchange routing information via BGP.

The connections are made at peering points / internet exchange points (ixps)

peeringdb.com

NJEDGE peers with the NY International Internet eXchange point (NYIIX).

NYIIX is owned by Telstra.

AS26101 is not in the peeringdb
neither is Stevens' AS16889

Not every network directly peers with others at a public ixp. There are private connections made.

Open source network traffic graphing tool: mrtg

todo:
- identify AS numbers and find where they peer
- research depeering and its impacts on network performance
- review the list of largest exchange points on Wikipedia and compare their throughput
  - try to find out about the Network Access Point of the Americas (NAP of the Americas by Equinix)
- consider the NANOG (North American Network Operators Group) mailing list.

---

# Checkpoint

> What is the difference between an IPv4 and an IPv6 address?

IPv4 has 32 bits and IPv6 has 128 bits. The header layouts of IPv4 and IPv6 are
different.

> What do a captured HTTP packet for traffic from the same host to an IPv4
> and an IPv6 host on the internet have in common? What's different?

common:
4 bit for the version number
1 byte for DSCP and ECN
2 byte packet length
1 byte hop limit / ttl with default 64 (0x40)
1 byte protocol version
source address
destination address

differences:
version numbers are different
no header len in IPv6
IPv6 has 20 bits for flow label
IPv4 has 2 byte identification
IPv4 has flags and fragment offset
IPv6 has type of next header, which is usually the protocol header
IPv4 has a 2 byte header checksum
addresses are 128 bit for IPv6 and 32 bit for IPv4

> What is a netmask, and why do we need it?

A netmask allows you to divide a network into smaller networks or subnets. This
is important because we all need some address space. Dividing the IP space
among different entities allows us have addresses. However, there is a problem
with fragmentation if some subnets are too big and not all the addresses are
used.

> What is a RIR and what is an LIR? Give an example of each.

Regional Internet Registries (RIRs) are top level internet registries that deal
with entire continents. The ARIN (American Registry for Internet Numbers), for
example, covers the US and Canada.

Local Internet Registries (LIRs) are organizations that receive blocks of IP
addresses from RIRs and further divide those blocks for end users. An example
would be Stevens or an ISP like Verizon.

> What's the default allocation or assignment for IPv6 subnets to end users?

/64 subnets are the default allocations given to single end user LANs.

> Identify a submarine communications cable - which landing points does it connect?

Southern Cross Cable Network (SCCN)

Landing Points
- Alexandria, NSW, Australia
- Brookvale, NSW, Australia
- Suva, Fiji
- Takapuna, New Zealand
- Whenuapai, New Zealand
- Hillsboro, OR, United States
- Kahe Point, HI, United States
- Morro Bay, CA, United States
- Spencer Beach, HI, United States

> Identify a major internet outage or disruption event in the last 5 years that
> was not mentioned in the videos:

I'm assuming an IT issue that affects the Internet in a negative way counts as
an internet outage or disruption. If correct, then the Crowdstrike outage from
last summer counts as an example.

---

"We can't send email more than 500 miles."
- https://web.mit.edu/jemorris/humor/500-miles
- sendmail update
- OS update (sendmail downgrade)
- missing settings initialized to 0
- one of the settings was timeout for connections
- zero timeout -> 3ms
- c = 299792458 m/s
- 558.85 miles

Layer 2 vs Layer 3
Hub and Switch on layer 2
- hub repeats for all ports
- switch checks destination MAC unless broadcast
  - gets broadcast domain through the broadcast IP.
Router on layer 3

How doable is creating a network that connects to the Internet without paying an ISP?

If you want to avoid an ISP, request an ASN and convince someone to get an uplink.
- https://blog.apnic.net/2022/07/01/how-i-set-up-my-own-autonomous-system/
- https://chown.me/blog/getting-my-own-asn

- https://www.youtube.com/watch?v=ASXJgvy3mEg
- Jared Mauch

How can you create and manage multiple subnets from their allocated IP space?

Anycasting - reuse same ip multiple times?
https://www.cloudflare.com/learning/cdn/glossary/anycast-network/

ip-ranges for AWS
- https://ip-ranges.amazonaws.com/ip-ranges.json
- with the math, 153,852,018 IPs

CIDR allocations
https://www.netmeister.org/blog/cidr-allocations.html

DOD owns ~8% of the IP space.

Why has IPv6 adoption been so slow?
- we have local ip space. we just use NAT. NAT is a big pain.
- whole lot of incentives for IPv4

`host url` does dns lookup

